<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Discord Gift Sender</title>
<style>
body { font-family: Arial, sans-serif; padding: 24px; max-width: 720px; }
button, input { font-size: 1rem; padding: 8px 12px; margin: 6px 0; }
#output { margin-top: 12px; font-weight: 600; word-break: break-all; }
.controls { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
label { display:flex; gap:8px; align-items:center; }
.small { font-size:0.9rem; color:#555; }
</style>
</head>
<body>
<h2>Generate random 18-character code and send to Discord webhook</h2>
<div class="controls">
<button id="generateBtn">Generate & Send</button>
<button id="copyBtn">Copy Last</button>
<label>
<input type="checkbox" id="autoSendToggle" /> Auto-send every
</label>
<input id="intervalInput" type="number" min="2" value="5" style="width:72px;" />
<button id="stopAutoBtn" disabled>Stop Auto</button>
</div>
<p id="status" class="small">Status: idle</p>
<p id="output">—</p>

<script>
const CODE_LENGTH = 18;
const AUTO_SEND_MIN_SECONDS = 0.3;

function generateCode(length = CODE_LENGTH) {
  const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  const out = new Array(length);
  const random = new Uint32Array(length);
  crypto.getRandomValues(random);
  for (let i = 0; i < length; i++) out[i] = alphabet[random[i] % alphabet.length];
  return out.join('');
}

async function sendToProxy(message) {
  try {
    const res = await fetch('/api/send', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Unknown error');
    return true;
  } catch (err) {
    throw err;
  }
}

const generateBtn = document.getElementById("generateBtn");
const copyBtn = document.getElementById("copyBtn");
const statusEl = document.getElementById("status");
const outputEl = document.getElementById("output");
const autoToggle = document.getElementById("autoSendToggle");
const intervalInput = document.getElementById("intervalInput");
const stopAutoBtn = document.getElementById("stopAutoBtn");

let lastCode = "";
let autoIntervalId = null;

function setStatus(text, isError = false) {
  statusEl.textContent = `Status: ${text}`;
  statusEl.style.color = isError ? "crimson" : "";
}

async function generateAndSend() {
  generateBtn.disabled = true;
  setStatus("Generating & sending...");
  try {
    const code = generateCode();
    lastCode = code;
    const msg = `discord.gift/${code}`;
    outputEl.textContent = msg;
    await sendToProxy(msg);
    setStatus("Sent successfully.");
  } catch (err) {
    setStatus("Send failed. See console.", true);
    console.error(err);
  } finally {
    generateBtn.disabled = false;
  }
}

generateBtn.addEventListener("click", generateAndSend);

copyBtn.addEventListener("click", () => {
  if (!lastCode) return setStatus("Nothing to copy yet.", true);
  navigator.clipboard.writeText(`discord.gift/${lastCode}`)
    .then(() => setStatus("Copied last code to clipboard."))
    .catch(() => setStatus("Copy failed.", true));
});

autoToggle.addEventListener("change", () => {
  if (autoToggle.checked) {
    let secs = Number(intervalInput.value) || 5;
    if (secs < AUTO_SEND_MIN_SECONDS) { secs = AUTO_SEND_MIN_SECONDS; intervalInput.value = secs; }
    startAutoSend(secs);
  } else stopAutoSend();
});

stopAutoBtn.addEventListener("click", stopAutoSend);

function startAutoSend(seconds) {
  if (autoIntervalId) clearInterval(autoIntervalId);
  setStatus(`Auto-sending every ${seconds}s`);
  stopAutoBtn.disabled = false;
  generateBtn.disabled = true;

  (async () => { try { const code = generateCode(); lastCode = code; const msg = `discord.gift/${code}`; outputEl.textContent = msg; await sendToProxy(msg); setStatus(`Auto send: sent at ${new Date().toLocaleTimeString()}`); } catch(e){ setStatus("Auto send failed. Stopping.", true); autoToggle.checked=false; stopAutoSend(); } })();

  autoIntervalId = setInterval(async () => {
    try {
      const code = generateCode();
      lastCode = code;
      const msg = `discord.gift/${code}`;
      outputEl.textContent = msg;
      await sendToProxy(msg);
      setStatus(`Auto send: sent at ${new Date().toLocaleTimeString()}`);
    } catch(e){ setStatus("Auto send failed. Stopping.", true); autoToggle.checked=false; stopAutoSend(); }
  }, seconds*1000);
}

function stopAutoSend() {
  if (autoIntervalId) { clearInterval(autoIntervalId); autoIntervalId = null; }
  stopAutoBtn.disabled = true;
  generateBtn.disabled = false;
  setStatus("Auto sending stopped.");
}

intervalInput.addEventListener("change", () => {
  const v = Number(intervalInput.value) || 5;
  if (v < AUTO_SEND_MIN_SECONDS) intervalInput.value = AUTO_SEND_MIN_SECONDS;
});

setStatus("idle");
outputEl.textContent = "—";
console.log("Use responsibly. Avoid spamming webhooks or fraudulent codes.");
</script>
</body>
</html>
